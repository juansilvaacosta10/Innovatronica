<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cotizador Pro Innovatronica</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 h-screen flex flex-col">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        // --- PON TU URL DE N8N AQU√ç (Production URL) ---
        const N8N_URL = "https://1.jisn8n.work/webhook/innovatronica-api"; 

        const { useState, useEffect, useRef } = React;

        function App() {
            const [messages, setMessages] = useState([
                { role: 'ai', text: 'Hola, soy el asistente de Innovatronica. ¬øQu√© instrumento necesitas hoy?' }
            ]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const [modalOpen, setModalOpen] = useState(false);
            const [currentModel, setCurrentModel] = useState(null);
            const [options, setOptions] = useState({});
            const [selections, setSelections] = useState({});
            const [cart, setCart] = useState([]);
            const messagesEndRef = useRef(null);

            const scrollToBottom = () => messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            useEffect(scrollToBottom, [messages]);

            // 1. Enviar mensaje al Chat
            const sendMessage = async () => {
                if (!input.trim()) return;
                const text = input;
                setInput('');
                setMessages(prev => [...prev, { role: 'user', text }]);
                setLoading(true);

                try {
                    const res = await fetch(N8N_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'chat', message: text })
                    });
                    const data = await res.json();
                    
                    // La IA responde texto y opcionalmente sugiere un modelo
                    setMessages(prev => [...prev, { 
                        role: 'ai', 
                        text: data.reply, 
                        suggestedModel: data.suggestedModel // Si la IA detecta modelo, viene aqu√≠
                    }]);
                } catch (e) {
                    console.error(e);
                    setMessages(prev => [...prev, { role: 'ai', text: "Error de conexi√≥n." }]);
                }
                setLoading(false);
            };

            // 2. Pedir opciones al Excel (Click en bot√≥n "Configurar")
            const openConfigurator = async (modelId) => {
                setLoading(true);
                try {
                    const res = await fetch(N8N_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'get_options', model: modelId })
                    });
                    const data = await res.json();
                    setOptions(data.categories);
                    setCurrentModel(modelId);
                    setSelections({});
                    setModalOpen(true);
                } catch (e) {
                    alert("Error cargando opciones");
                }
                setLoading(false);
            };

            // 3. Calcular precio y agregar al carrito
            const addToCart = async () => {
                setLoading(true);
                try {
                    const res = await fetch(N8N_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            action: 'calculate', 
                            model: currentModel, 
                            selections: selections 
                        })
                    });
                    const data = await res.json(); // Esperamos { finalCode: "...", price: 1234 }
                    
                    setCart(prev => [...prev, {
                        model: currentModel,
                        code: data.finalCode,
                        price: data.price,
                        details: selections
                    }]);
                    setModalOpen(false);
                    setMessages(prev => [...prev, { role: 'ai', text: `‚úÖ Agregado al carrito: ${currentModel} (${data.finalCode}) - $${data.price}` }]);
                } catch (e) {
                    alert("Error calculando precio");
                }
                setLoading(false);
            };

            // 4. Generar Cotizaci√≥n Final (PDF)
            const finalizeQuote = async () => {
                if(cart.length === 0) return;
                setLoading(true);
                try {
                    const res = await fetch(N8N_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'finalize', items: cart })
                    });
                    const data = await res.json();
                    if(data.pdfUrl) {
                         setMessages(prev => [...prev, { role: 'ai', text: `üìÑ Cotizaci√≥n generada exitosamente. Desc√°rgala aqu√≠: ${data.pdfUrl}` }]);
                         window.open(data.pdfUrl, '_blank');
                    } else {
                        setMessages(prev => [...prev, { role: 'ai', text: "Cotizaci√≥n generada (Simulaci√≥n). Revisa n8n." }]);
                    }
                } catch (e) {
                    alert("Error generando PDF");
                }
                setLoading(false);
            };

            return (
                <div className="flex h-full max-w-6xl mx-auto shadow-xl">
                    {/* Chat Area */}
                    <div className="w-2/3 flex flex-col bg-white">
                        <div className="p-4 border-b bg-blue-600 text-white font-bold">Asistente de Ventas</div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-4">
                            {messages.map((msg, i) => (
                                <div key={i} className={`flex flex-col ${msg.role === 'user' ? 'items-end' : 'items-start'}`}>
                                    <div className={`p-3 rounded-lg max-w-md ${msg.role === 'user' ? 'bg-blue-100 text-blue-900' : 'bg-gray-100 text-gray-800'}`}>
                                        {msg.text}
                                    </div>
                                    {/* Bot√≥n m√°gico si la IA sugiere modelo */}
                                    {msg.suggestedModel && (
                                        <button 
                                            onClick={() => openConfigurator(msg.suggestedModel)}
                                            className="mt-2 bg-green-500 text-white px-4 py-2 rounded shadow hover:bg-green-600 transition flex items-center gap-2"
                                        >
                                            <i className="fas fa-tools"></i> Configurar {msg.suggestedModel}
                                        </button>
                                    )}
                                </div>
                            ))}
                            <div ref={messagesEndRef} />
                        </div>
                        <div className="p-4 border-t flex gap-2">
                            <input 
                                className="flex-1 border p-2 rounded" 
                                value={input} 
                                onChange={e => setInput(e.target.value)}
                                onKeyPress={e => e.key === 'Enter' && sendMessage()}
                                placeholder="Escribe aqu√≠..."
                                disabled={loading}
                            />
                            <button onClick={sendMessage} className="bg-blue-600 text-white px-4 rounded hover:bg-blue-700">Enviar</button>
                        </div>
                    </div>

                    {/* Sidebar Carrito */}
                    <div className="w-1/3 bg-gray-50 border-l p-4 flex flex-col">
                        <h2 className="text-xl font-bold mb-4 text-gray-700">Carrito de Cotizaci√≥n</h2>
                        <div className="flex-1 overflow-y-auto space-y-3">
                            {cart.length === 0 && <p className="text-gray-400 text-center mt-10">El carrito est√° vac√≠o</p>}
                            {cart.map((item, i) => (
                                <div key={i} className="bg-white p-3 rounded shadow border-l-4 border-blue-500">
                                    <div className="font-bold">{item.model}</div>
                                    <div className="text-xs text-gray-500">{item.code}</div>
                                    <div className="text-right font-mono font-bold text-green-600">${item.price}</div>
                                </div>
                            ))}
                        </div>
                        <div className="border-t pt-4 mt-4">
                            <div className="flex justify-between font-bold text-lg mb-4">
                                <span>Total:</span>
                                <span>${cart.reduce((a, b) => a + b.price, 0).toFixed(2)}</span>
                            </div>
                            <button 
                                onClick={finalizeQuote}
                                disabled={cart.length === 0 || loading}
                                className="w-full bg-blue-800 text-white py-3 rounded font-bold hover:bg-blue-900 disabled:opacity-50"
                            >
                                {loading ? 'Procesando...' : 'Generar Cotizaci√≥n PDF'}
                            </button>
                        </div>
                    </div>

                    {/* Modal Configurador */}
                    {modalOpen && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-lg w-full max-w-lg max-h-[90vh] flex flex-col">
                                <div className="p-4 border-b flex justify-between items-center bg-gray-100 rounded-t-lg">
                                    <h3 className="font-bold text-lg">Configurar {currentModel}</h3>
                                    <button onClick={() => setModalOpen(false)} className="text-gray-500 hover:text-red-500">&times;</button>
                                </div>
                                <div className="p-6 overflow-y-auto flex-1">
                                    {Object.entries(options).map(([cat, opts]) => (
                                        <div key={cat} className="mb-4">
                                            <label className="block text-sm font-bold text-gray-700 mb-1">{cat}</label>
                                            <select 
                                                className="w-full border p-2 rounded"
                                                onChange={e => setSelections({...selections, [cat]: e.target.value})}
                                            >
                                                <option value="">-- Seleccionar --</option>
                                                {opts.map((o, i) => (
                                                    <option key={i} value={o.Codigo_Opcion}>
                                                        {o.Descripcion} {o.Precio > 0 ? `(+${o.Precio})` : ''}
                                                    </option>
                                                ))}
                                            </select>
                                        </div>
                                    ))}
                                </div>
                                <div className="p-4 border-t">
                                    <button onClick={addToCart} className="w-full bg-green-600 text-white py-2 rounded font-bold hover:bg-green-700">
                                        Agregar al Carrito
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
